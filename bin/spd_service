#!/bin/bash
# designed for ss and privoxy in docker
# Philosophy: docker spd server should start from the beginning,we only set corresponding http/https 
# to utilize it.
set -e
cd "$(dirname $0)"/..
LOCAL_PORT=8118
CONTAINER_NAME=shadowsocks_privoxy_docker
SERVER_IP=`head -1 config/account.txt`

start_container(){
    # echo This script may need sudo priviledge
    stop_container_if_exists
    
    # echo Reopen a new container
    docker run -d -e SERVER_ADDR=$SERVER_IP -p $LOCAL_PORT:8118 --name $CONTAINER_NAME ss:v1
}

stop_container_if_exists(){
    if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
        # echo Killing original container
        if [ ! "$(docker ps -aq -f status=exited -f name=$CONTAINER_NAME)" ]; then
            # echo Original container is running, Stop
            docker stop $CONTAINER_NAME
        fi
        # echo Original container has stopped, remove original container
        docker rm $CONTAINER_NAME
    fi
}

# useless if this file is not sourced
if [ "$1" = "start" ];then
    start_container
    export http_proxy=127.0.0.1:$LOCAL_PORT
    export https_proxy=127.0.0.1:$LOCAL_PORT
    echo '
--------------------------------------------------------------------------------
  HINT: You have succeeded starting shadowsocks privoxy docker container, try
--------------------------------------------------------------------------------
# Settings
export https_proxy="127.0.0.1:8118" \
export http_proxy="127.0.0.1:8118"
# In your container or host machine
curl google.com
    '
    git config --global https.proxy https://127.0.0.1:$LOCAL_PORT

elif [ "$1" = "stop" ];then
    stop_container_if_exists
    export http_proxy=""
    export https_proxy=""

elif [ "$1" = "exec" ];then
    docker exec -it shadowsocks_privoxy_docker /bin/bash

else
    echo "Wrong parameter!Usage: proxy [start|stop]"
fi
